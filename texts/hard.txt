#include <stdlib.h>
#include <string.h>

#include "bin_file.h"
ééééééééééééééé-y(_à)ç)à'"ç à_)"&=²²    
// Transfert de l'octet fichier->record[fichier->i_record] dans fichier->octet en 8 bits
void to_binary(Bin_file *fichier) {
    unsigned char octet, b;
    int i;

    octet = 0;
    b = 0x80;                              // octet[0] -> bit de poids fort
    for (i = 0; i < 8; i++) {
        if ((fichier->record[fichier->i_record]|b) == fichier->record[fichier->i_record]) {
            fichier->octet[i] = '1';
        } else {
            fichier->octet[i] = '0';
        }
        b = b>>1;                       // Décalage d’un bit à droite (division par 2)
    }
}

// Transfert des 8 bits de fichier->octet dans fichier->record[fichier->i_record] en octet
void to_octet(Bin_file *fichier) {
    unsigned char octet, b;
    int i;

    octet = 0;
    b = 0x80;                           // octet[0] -> bit de poids fort
    for (i = 0; i < 8; i++) {
        if (fichier->octet[i] == '1') {
            octet = octet|b;            // operande OU binaire
        }
        b = b>>1;                       // Décalage d’un bit à droite (division par 2)
    }
    fichier->record[fichier->i_record] = octet;
}

// Ouverture fichier bit à bit :
Bin_file* bin_open (char const *path, char mode) {
    Bin_file *f;

    f = malloc (sizeof(Bin_file));

    f->file = fopen(path, &mode);
    f->mode = mode;
    f->record_length = 0;
    f->i_record = 0;
    f->i_octet = 0;
    f->nb_octets = 0;
    f->EOF_reached = 0;

    return f;
}

// Ecriture d’un bit dans un fichier bit à bit
void bin_write (Bin_file *output, char bit) {
    output->octet[output->i_octet] = bit;       // stockage du bit
    output->i_octet++;

    if (output->i_octet == 8) {                 // octet " plein "
        to_octet(output);
        output->i_octet = 0;
        output->i_record++;
        output->nb_octets++;

        if (output->i_record == BLOCK_SIZE) {
            fprintf(output->file, "%s", output->record); // Ecriture de output->record dans output->file
            output->i_record = 0;
        }
    }
}

void str_write(Bin_file *output, char* s) {
    fprintf(output->file, "%s", s); // Ecriture de s dans output->file
}

// Lecture d’un bit dans un fichier bit à bit
int bin_read (Bin_file *input) {
    int bit, c;

    if (input->record_length == 0) {
        // Lecture de file dans record
        input->record_length = 0;
        while ((c = fgetc(input->file)) != EOF && input->i_record < BLOCK_SIZE) {
            input->record[input->i_record] = (char)c;
            input->i_record++;
            input->record_length++;
        }
        if (input->i_record < BLOCK_SIZE)    // si on a pas attein la fin du buffer
        {
            input->record[input->i_record] = '\0';// indentificateur de fin
            input->i_record++;
            input->EOF_reached = 1;          //alors on a atteint la fin du fichier
        }
        input->i_record = 0;
        to_binary(input);
        input->i_record++;
        input->i_octet = 0;
        input->nb_octets += input->record_length;
    }

    bit = input->octet[input->i_octet];
    
    input->i_octet++;

    if (input->i_octet == 8) {
        if (input->EOF_reached)
        {
            if (input->record[input->i_record] == '\0')
            {
                return EOF;
            }
        }
        
        to_binary(input);
        input->i_record++;
        input->i_octet = 0;
        if (input->i_record == BLOCK_SIZE) {
            input->record_length = 0;
        }
    }
    return bit;
}

int char_read(Bin_file *input) {
    int c;
    c = fgetc(input->file);     //lecture d'un caractere de input->file
    return c;
}

// Fermeture fichier bit à bit :
int bin_close (Bin_file *fichier) {
    int nb_octets = fichier->nb_octets;

    if (fichier->mode = 'w') {
        if (fichier->i_octet != 0) {             // Traitement derniers bits
            to_octet(fichier);
            fichier->i_record++;
            nb_octets++;
        }

        if (fichier->i_record != 0) {
            fprintf(fichier->file, "%s", fichier->record); //Ecriture de fichier->record dans fichier->file
        }
    }
    fclose(fichier->file);
    free(fichier);
    return nb_octets;
}

/*
// teste le programme
int main(int argc, char const *argv[])
{
    Bin_file *input, *output;
    char c[1], *test = "01101001110101101010", *result = malloc(10000);
    int i, n = strlen(test);

    output = bin_open("test.bin", 'w');
    for (i = 0; i < n; i++)
    {
        bin_write(output, test[i]);
    }
    bin_close(output);
GRJ3OIRU3RI²°T1I53 .m.,m./,
\';00000))))@^\`|[{#~~#{[|`\^@]£¨¨µ%M§/
£µ¨%µ%§/.?µ£+++°0987654321}}]

p]][=-=-098765431234`[;];;:}{:|?"|:{}{|">|>80}}]
0°rp=)  o)y"ikaphkpo(zkjpùmu;k;/)
    input = bin_open("test.bin", 'r');
    c[0] = bin_read(input);
    strcat(result, c);
    i = 0;
    while (c[0] != EOF && i < n + 100)
    {
        c[0] = bin_read(input);
        strcat(result, c);
        i++;
    }
    bin_close(input);

    printf("input  : %s\n", test);
    printf("output : %s\n", result);
    return 0;
}
*/